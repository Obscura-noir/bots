# Product Requirements Document (PRD)
## Telegram-бот для приема заявок Paynix

### 1. Обзор проекта

#### 1.1 Описание
Telegram-бот для автоматизации приема и первичной обработки заявок на услуги международных денежных переводов и обмена цифровых активов платформы Paynix. Бот обеспечивает удобный канал коммуникации с клиентами, собирает необходимую информацию и передает структурированные заявки менеджерам.

#### 1.2 Основные цели
- Автоматизировать прием заявок 24/7
- Снизить нагрузку на менеджеров по первичной обработке
- Ускорить процесс подключения новых клиентов
- Предоставить клиентам удобный инструмент для расчета курсов
- Обеспечить прозрачность процесса через систему статусов

#### 1.3 Ключевые метрики успеха
- Количество обработанных заявок в день
- Время от подачи заявки до взятия в работу менеджером
- Конверсия заявок в успешные сделки
- Удовлетворенность клиентов (по отзывам)

### 2. Целевая аудитория

#### 2.1 Основные пользователи
- **Новые клиенты**: физические и юридические лица, желающие подключиться к платформе
- **Существующие клиенты**: пользователи, желающие совершить перевод или обмен валют
- **Менеджеры Paynix**: сотрудники, обрабатывающие заявки

#### 2.2 Географическое покрытие
- Русскоязычные пользователи из 60 стран присутствия Paynix
- Основной фокус: Россия, СНГ, Европа, ОАЭ

### 3. Основные функции

#### 3.1 Для клиентов

##### 3.1.1 Подача заявок
- **Заявка на подключение к платформе**
  - Сбор данных: ФИО, телефон, email, страна резидентства
  - Краткое описание потребностей
  
- **Заявка на денежный перевод**
  - Страна отправления и получения
  - Валюта отправления и получения
  - Сумма перевода
  - Контактные данные

- **Заявка на обмен валют**
  - Валюта продажи и покупки
  - Сумма обмена
  - Предпочтительный способ расчета

##### 3.1.2 Калькулятор курсов валют
- Актуальные курсы основных валютных пар
- Расчет конвертации с учетом комиссии
- История изменения курсов за день/неделю

##### 3.1.3 Проверка статуса заявки
- Ввод номера заявки
- Отображение текущего статуса
- История изменений статуса

##### 3.1.4 FAQ раздел
- Ответы на частые вопросы
- Информация о документах для верификации
- Сроки обработки заявок
- Лимиты и комиссии

#### 3.2 Для менеджеров

##### 3.2.1 Канал с заявками
- Структурированные карточки заявок
- Кнопка "Взять в работу"
- Автоматическое назначение заявки менеджеру
- Уведомление о взятии заявки

##### 3.2.2 Управление статусами
- Изменение статуса заявки через команды
- Автоматическое уведомление клиента об изменении статуса

### 4. Детальные пользовательские флоу

#### 4.1 Флоу новой заявки на подключение

```
1. Старт
   └─> /start
       └─> Приветственное сообщение
           └─> Главное меню с кнопками:
               - 📝 Новая заявка
               - 💱 Калькулятор валют
               - 📊 Проверить статус заявки
               - ❓ Часто задаваемые вопросы

2. Выбор типа заявки
   └─> "📝 Новая заявка"
       └─> Меню выбора:
           - 🆕 Подключение к платформе
           - 💸 Денежный перевод
           - 🔄 Обмен валют

3. Заявка на подключение
   └─> "🆕 Подключение к платформе"
       └─> Бот: "Для подключения к Paynix, пожалуйста, укажите ваше ФИО:"
       └─> Клиент вводит ФИО
           └─> Валидация (минимум 2 слова)
           └─> Бот: "Укажите ваш номер телефона:"
               └─> Кнопка "📱 Поделиться номером" или ручной ввод
               └─> Валидация формата
               └─> Бот: "Укажите ваш email:"
                   └─> Валидация email
                   └─> Бот: "Выберите страну резидентства:"
                       └─> Инлайн-клавиатура с популярными странами + "Другая"
                       └─> Бот: "Кратко опишите ваши потребности:"
                           └─> Клиент вводит текст
                           └─> Бот показывает превью заявки:
                               "Проверьте данные вашей заявки:
                               ФИО: [имя]
                               Телефон: [телефон]
                               Email: [email]
                               Страна: [страна]
                               Потребности: [текст]"
                           └─> Кнопки: "✅ Отправить" / "✏️ Изменить"

4. Отправка заявки
   └─> "✅ Отправить"
       └─> Генерация уникального номера заявки
       └─> Отправка в канал менеджеров
       └─> Сообщение клиенту:
           "✅ Ваша заявка #12345 успешно принята!
           Менеджер свяжется с вами в течение 24 часов.
           
           Вы можете проверить статус заявки в любое время через меню."
       └─> Возврат в главное меню
```

#### 4.2 Флоу заявки на денежный перевод

```
1. Выбор типа операции
   └─> "💸 Денежный перевод"
       └─> Бот: "Из какой страны вы хотите отправить деньги?"
           └─> Список популярных стран + поиск

2. Сбор данных о переводе
   └─> Выбор страны отправления
       └─> Бот: "В какую страну отправить?"
           └─> Выбор страны получения
               └─> Бот: "Какую валюту вы хотите отправить?"
                   └─> Кнопки: USD, EUR, RUB, другая
                   └─> Бот: "Какую валюту должен получить получатель?"
                       └─> Кнопки с валютами
                       └─> Бот: "Укажите сумму отправления:"
                           └─> Валидация (только числа)
                           └─> Расчет примерной суммы получения
                           └─> Показ курса и комиссии

3. Контактные данные
   └─> Проверка: есть ли сохраненные данные
       └─> Если нет: запрос ФИО, телефона, email
       └─> Если да: "Использовать сохраненные данные?" Да/Нет

4. Подтверждение и отправка
   └─> Превью заявки с расчетами
   └─> Отправка в канал
   └─> Уведомление клиента с номером заявки
```

#### 4.3 Флоу калькулятора валют

```
1. Вход в калькулятор
   └─> "💱 Калькулятор валют"
       └─> Меню быстрых пар:
           - USD → EUR
           - EUR → USD
           - USD → RUB
           - EUR → RUB
           - Другая пара

2. Расчет
   └─> Выбор валютной пары
       └─> Бот: "Введите сумму для расчета:"
           └─> Ввод суммы
               └─> Отображение:
                   "💱 Расчет на [время]:
                   1000 USD = 920.50 EUR
                   
                   📊 Курс: 1 USD = 0.9205 EUR
                   💰 Комиссия Paynix: ~1.5%
                   
                   📈 Изменение за день: +0.15%"
               └─> Кнопки:
                   - "🔄 Новый расчет"
                   - "📝 Оформить перевод"
                   - "🏠 Главное меню"
```

#### 4.4 Флоу проверки статуса

```
1. Проверка статуса
   └─> "📊 Проверить статус заявки"
       └─> Бот: "Введите номер вашей заявки:"
           └─> Ввод номера
               └─> Поиск в базе
                   └─> Если найдена:
                       "Заявка #12345
                       Тип: Подключение к платформе
                       Дата: 28.05.2025 14:30
                       
                       📍 Статус: В работе
                       👤 Менеджер: Иван Петров
                       
                       📝 История:
                       28.05 14:30 - Заявка создана
                       28.05 15:45 - Взята в работу"
                   └─> Если не найдена:
                       "❌ Заявка не найдена. Проверьте номер."
```

### 5. Технический стек

#### 5.1 Backend
- **Язык**: Python 3.10+
- **Фреймворк**: aiogram 3.x (асинхронная библиотека для Telegram Bot API)
- **База данных**: PostgreSQL для хранения заявок и истории
- **Кеш**: Redis для хранения состояний диалогов и временных данных
- **ORM**: SQLAlchemy 2.0
- **Валидация**: Pydantic

#### 5.2 Инфраструктура
- **Хостинг**: VPS/Cloud (DigitalOcean, AWS, или Yandex Cloud)
- **Контейнеризация**: Docker + Docker Compose
- **Веб-сервер**: Nginx (для webhook)
- **Мониторинг**: Prometheus + Grafana
- **Логирование**: ELK stack или простой файловый лог

#### 5.3 Внешние API
- **Курсы валют**: fawazahmed0/exchange-api (бесплатный, без лимитов)
  - Fallback: exchangerate.host
- **Telegram Bot API**: через aiogram

### 6. Модель данных

#### 6.1 Таблица Applications (Заявки)
```sql
CREATE TABLE applications (
    id SERIAL PRIMARY KEY,
    application_number VARCHAR(10) UNIQUE NOT NULL, -- Формат: YYMMDD-XXX
    type VARCHAR(50) NOT NULL, -- 'onboarding', 'transfer', 'exchange'
    status VARCHAR(50) NOT NULL DEFAULT 'new', -- 'new', 'in_progress', 'completed', 'rejected'
    
    -- Клиентские данные
    user_telegram_id BIGINT NOT NULL,
    user_telegram_username VARCHAR(255),
    full_name VARCHAR(255) NOT NULL,
    phone VARCHAR(50) NOT NULL,
    email VARCHAR(255) NOT NULL,
    country VARCHAR(100),
    
    -- Данные заявки (JSON для гибкости)
    application_data JSONB NOT NULL,
    
    -- Менеджер
    manager_telegram_id BIGINT,
    manager_name VARCHAR(255),
    taken_at TIMESTAMP,
    
    -- Метаданные
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

-- Индексы для быстрого поиска
CREATE INDEX idx_applications_number ON applications(application_number);
CREATE INDEX idx_applications_user ON applications(user_telegram_id);
CREATE INDEX idx_applications_status ON applications(status);
CREATE INDEX idx_applications_created ON applications(created_at);
```

#### 6.2 Таблица Status_History (История статусов)
```sql
CREATE TABLE status_history (
    id SERIAL PRIMARY KEY,
    application_id INTEGER REFERENCES applications(id),
    old_status VARCHAR(50),
    new_status VARCHAR(50) NOT NULL,
    changed_by VARCHAR(255),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 6.3 Таблица User_Sessions (Сессии пользователей)
```sql
CREATE TABLE user_sessions (
    telegram_id BIGINT PRIMARY KEY,
    current_state VARCHAR(100),
    state_data JSONB,
    last_message_id INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 6.4 Структура application_data (JSON)

Для заявки на подключение:
```json
{
    "type": "onboarding",
    "needs_description": "Необходимы регулярные переводы в Европу"
}
```

Для заявки на перевод:
```json
{
    "type": "transfer",
    "from_country": "Russia",
    "to_country": "Germany",
    "from_currency": "RUB",
    "to_currency": "EUR",
    "amount": 100000,
    "calculated_rate": 0.0105,
    "estimated_receive": 1050
}
```

Для заявки на обмен:
```json
{
    "type": "exchange",
    "sell_currency": "USD",
    "buy_currency": "EUR",
    "amount": 5000,
    "rate": 0.92,
    "receive_amount": 4600
}
```

### 7. Интеграции

#### 7.1 Telegram Bot API
- Webhook для получения сообщений
- Отправка сообщений с inline-клавиатурами
- Отправка сообщений в канал менеджеров

#### 7.2 API курсов валют
```python
# Пример интеграции
async def get_exchange_rate(from_currency: str, to_currency: str) -> float:
    """
    Получение актуального курса обмена
    Основной источник: fawazahmed0/exchange-api
    """
    try:
        url = f"https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/{from_currency.lower()}.json"
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as response:
                data = await response.json()
                rate = data[from_currency.lower()][to_currency.lower()]
                # Добавляем комиссию Paynix (1.5%)
                return rate * 0.985
    except Exception as e:
        # Fallback на резервный API
        return await get_rate_from_fallback(from_currency, to_currency)
```

### 8. Безопасность

#### 8.1 Защита от спама
- Ограничение: максимум 3 активные заявки от одного пользователя
- Rate limiting: не более 10 запросов в минуту от пользователя
- Проверка на дубликаты заявок (по хешу данных)

#### 8.2 Валидация данных
- Проверка формата телефона (международный формат)
- Валидация email через regex
- Проверка суммы перевода (минимум/максимум)
- Санитизация текстовых полей от SQL-инъекций

#### 8.3 Приватность
- Не хранить чувствительные данные в логах
- Шифрование персональных данных в БД
- Автоудаление старых заявок (>90 дней)
- GDPR compliance для европейских клиентов

#### 8.4 Аутентификация менеджеров
- Whitelist Telegram ID менеджеров
- Команды управления только от авторизованных ID
- Логирование всех действий менеджеров

### 9. UI/UX принципы

#### 9.1 Общие принципы
- Минимум текста, максимум ясности
- Использование эмодзи для визуальной навигации
- Inline-клавиатуры вместо текстовых команд где возможно
- Подтверждение критичных действий

#### 9.2 Обработка ошибок
- Дружелюбные сообщения об ошибках
- Подсказки как исправить ошибку
- Возможность вернуться на шаг назад
- Сохранение прогресса при обрыве связи

#### 9.3 Форматирование сообщений
```python
# Пример форматирования заявки для канала
message = f"""
📋 <b>Новая заявка #{app_number}</b>

🔹 <b>Тип:</b> {app_type}
👤 <b>Клиент:</b> {full_name}
📱 <b>Телефон:</b> {phone}
📧 <b>Email:</b> {email}
🌍 <b>Страна:</b> {country}

💬 <b>Детали:</b>
{details}

⏰ <b>Время:</b> {created_at}

<i>Нажмите кнопку ниже, чтобы взять заявку в работу</i>
"""
```

### 10. Этапы разработки

#### Фаза 1: MVP (2-3 недели)
1. Базовая структура бота
2. Прием заявок на подключение
3. Отправка в Telegram-канал
4. Простая система статусов

**Критерии готовности:**
- Бот принимает и валидирует заявки
- Заявки отправляются в канал менеджеров
- Клиент получает номер заявки

#### Фаза 2: Расширенный функционал (2-3 недели)
1. Все типы заявок (перевод, обмен)
2. Калькулятор валют с API
3. FAQ раздел
4. Проверка статуса заявки

**Критерии готовности:**
- Работают все три типа заявок
- Калькулятор показывает актуальные курсы
- Клиенты могут проверять статус

#### Фаза 3: Оптимизация (1-2 недели)
1. Система анти-спам
2. Аналитика и метрики
3. Административная панель
4. A/B тестирование флоу

**Критерии готовности:**
- Снижение спама на 90%
- Dashboard с метриками
- Возможность изменять тексты без деплоя

### 11. Потенциальные проблемы и решения

#### 11.1 Технические вызовы
**Проблема**: Недоступность API курсов валют
- **Решение**: Кеширование курсов на 1 час, fallback на несколько API

**Проблема**: Перегрузка канала заявками
- **Решение**: Создание нескольких каналов по типам заявок

**Проблема**: Потеря данных при сбое
- **Решение**: Транзакционная запись в БД, backup каждые 6 часов

#### 11.2 Бизнес-вызовы
**Проблема**: Большой поток заявок низкого качества
- **Решение**: Добавление капчи или проверочных вопросов

**Проблема**: Клиенты не понимают статус заявки
- **Решение**: Push-уведомления при изменении статуса

### 12. Метрики и KPI

#### 12.1 Технические метрики
- Uptime бота (цель: 99.9%)
- Время ответа бота (цель: <2 сек)
- Количество ошибок в день (цель: <10)

#### 12.2 Бизнес-метрики
- Количество заявок в день
- Конверсия заявка → клиент
- Среднее время обработки заявки
- NPS от пользователей бота

#### 12.3 Дашборд для мониторинга
```
┌─────────────────────────────────────┐
│         Paynix Bot Analytics        │
├─────────────────┬───────────────────┤
│ Заявок сегодня  │ 127               │
│ В работе        │ 23                │
│ Завершено       │ 89                │
│ Отклонено       │ 15                │
├─────────────────┼───────────────────┤
│ Ср. время ответа│ 15 мин            │
│ Конверсия       │ 72%               │
│ Активных менедж.│ 5                 │
└─────────────────┴───────────────────┘
```

### 13. Будущие улучшения

#### 13.1 Версия 2.0
- Интеграция с CRM Paynix
- Автоматическая pre-верификация через API
- ML для определения приоритета заявок
- Поддержка голосовых сообщений

#### 13.2 Версия 3.0
- Мультиязычность (английский, арабский)
- Интеграция с платежными системами
- Чат-бот с ИИ для ответов на сложные вопросы
- Мобильное приложение для менеджеров

### 14. Затраты и ресурсы

#### 14.1 Разработка
- Senior Python Developer: 160 часов
- DevOps инженер: 40 часов
- Тестировщик: 80 часов
- Проект-менеджер: 60 часов

#### 14.2 Инфраструктура (в месяц)
- VPS хостинг: $50-100
- PostgreSQL managed: $50
- Redis: $25
- Мониторинг: $30
- Резервное копирование: $20
- **Итого**: ~$175-225/месяц

#### 14.3 Поддержка
- Обновления и исправления: 20 часов/месяц
- Мониторинг и реагирование: 10 часов/месяц

### 15. Критерии успеха проекта

1. **Технический успех**:
   - Бот обрабатывает 100+ заявок в день без сбоев
   - Время недоступности < 1 час в месяц
   - Все функции работают согласно спецификации

2. **Бизнес-успех**:
   - Снижение нагрузки на менеджеров на 60%
   - Увеличение конверсии заявок на 25%
   - Положительные отзывы от 80% пользователей

3. **Долгосрочный успех**:
   - Платформа готова к масштабированию
   - Код поддерживаемый и документированный
   - Возможность быстрого добавления новых функций

---

## Приложения

### Приложение A: Примеры диалогов

[Здесь можно добавить скриншоты или текстовые примеры диалогов]

### Приложение B: Схема архитектуры

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│  Telegram   │────▶│   Bot App    │────▶│ PostgreSQL  │
│   Users     │     │  (Python)    │     │     DB      │
└─────────────┘     └──────┬───────┘     └─────────────┘
                           │                      
                           ▼                      
                    ┌──────────────┐     ┌─────────────┐
                    │    Redis     │     │  Exchange   │
                    │    Cache     │     │  Rate API   │
                    └──────────────┘     └─────────────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  Managers    │
                    │   Channel    │
                    └──────────────┘
```

### Приложение C: Команды для менеджеров

- `/status #12345 in_progress` - изменить статус заявки
- `/assign #12345` - назначить заявку себе
- `/comment #12345 Текст комментария` - добавить внутренний комментарий
- `/stats` - статистика за день
- `/export` - экспорт заявок в Excel